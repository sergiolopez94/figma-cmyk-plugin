# Figma Plugin Development Guidelines

This document outlines the key requirements and best practices for developing Figma plugins, based on our learnings from Phase 1.

## Figma Plugin Structure Requirements

### 1. File Organization
```
project/
├── src/                    # Source files (TypeScript)
│   ├── code.ts            # Main plugin logic (runs in Figma sandbox)
│   ├── ui.html            # Plugin UI template
│   └── ui.ts              # UI logic (runs in iframe)
├── dist/                   # Built files (generated by webpack)
│   ├── code.js            # Compiled plugin code
│   └── ui.html            # UI with inlined JavaScript
├── manifest.json          # Plugin configuration
├── package.json           # Dependencies
├── tsconfig.json          # TypeScript configuration
└── webpack.config.js      # Bundler configuration
```

### 2. Bundling Requirements

**CRITICAL**: Figma plugins require proper bundling:
- All JavaScript must be bundled into single files
- UI JavaScript must be inlined into the HTML file
- External script tags (`<script src="...">`) are NOT supported
- Use webpack or similar bundler to handle this

### 3. Message Passing

Communication between plugin code and UI uses structured messages:

```typescript
// From UI to plugin (ui.ts)
parent.postMessage({ pluginMessage: { type: 'action-name', data: {} } }, '*');

// From plugin to UI (code.ts)
figma.ui.postMessage({ type: 'response-name', data: {} });

// Receiving in plugin (code.ts)
figma.ui.onmessage = (msg) => {
  if (msg.type === 'action-name') {
    // Handle message
  }
};

// Receiving in UI (ui.ts)
window.onmessage = (event) => {
  const msg = event.data.pluginMessage;
  if (msg && msg.type === 'response-name') {
    // Handle message
  }
};
```

### 4. DOM Ready Handling

Always wait for DOM to be ready before accessing elements:

```typescript
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeUI);
} else {
  initializeUI();
}
```

## Development Workflow

### 1. Setup
```bash
npm install                 # Install dependencies
npm run build              # Build for production
npm run dev                # Watch mode for development
```

### 2. Testing
1. Build the plugin: `npm run build`
2. In Figma Desktop: Plugins → Development → Import plugin from manifest
3. Select `manifest.json` from your project
4. Test changes by rebuilding and rerunning the plugin

### 3. Debugging
- Use `console.log()` for debugging
- View logs in Figma: View → Developer → Show/Hide Console
- In development mode, console logs are preserved

## Build Configuration

### webpack.config.js
```javascript
const HtmlWebpackPlugin = require('html-webpack-plugin');
const HtmlInlineScriptPlugin = require('html-inline-script-webpack-plugin');

module.exports = (env, argv) => ({
  mode: argv.mode === 'production' ? 'production' : 'development',
  devtool: argv.mode === 'production' ? false : 'inline-source-map',
  
  entry: {
    code: './src/code.ts',
    ui: './src/ui.ts'
  },
  
  // ... other config ...
  
  plugins: [
    new HtmlWebpackPlugin({
      template: './src/ui.html',
      filename: 'ui.html',
      chunks: ['ui'],
      cache: false
    }),
    new HtmlInlineScriptPlugin()  // Critical for Figma plugins
  ]
});
```

## Common Pitfalls to Avoid

1. **External Scripts**: Never use `<script src="external.js">` in ui.html
2. **Direct DOM Access**: Always check if elements exist before using them
3. **Message Structure**: Always wrap messages in `pluginMessage` object
4. **TypeScript Types**: Install `@figma/plugin-typings` for proper type support
5. **Build Output**: Ensure `manifest.json` points to built files in `dist/`

## Phase-Specific Guidelines

### Phase 2 (CMYK Conversion)
- Implement color conversion algorithms in separate utility files
- Test conversions thoroughly before integrating with UI
- Consider performance for large selections

### Phase 3 (UI Enhancement)
- shadcn components need to be bundled properly
- Keep UI responsive during long operations
- Use proper loading states

### Phase 4-6 (Export Features)
- Handle file operations carefully
- Implement proper error handling
- Consider memory usage for large exports

## Commands to Remember

```bash
# Development
npm run dev                # Start watch mode
npm run build             # Build for production

# Git workflow
git checkout -b phase-X   # Create new phase branch
git add -A               # Stage all changes
git commit -m "message"  # Commit changes
git push origin branch   # Push to GitHub

# Testing
# Always rebuild after changes
# Reload plugin in Figma to see updates
```

## Resources

- [Figma Plugin API](https://www.figma.com/plugin-docs/)
- [Figma Plugin Samples](https://github.com/figma/plugin-samples)
- [TypeScript Handbook](https://www.typescriptlang.org/docs/)